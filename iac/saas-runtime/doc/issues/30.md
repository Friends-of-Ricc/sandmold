# Issue #30: First iteration working. Now lets make it work for everything

## Original Request (from GitHub Issue)

Today we hit the first milestone: we were able to implement in code the online tutorial for SaaS Runtime. This is detailed in issue #27.

Now, to make this work for multiple versions, we need the scripts to stop reading a static .env with "ground" values, but being able to call these from CLI. Also, we need to support different TF foldes, with different variables, so we need to become smarter at this.

## Changes to implement.

1. Stop reading from .env and get the values as ARGV[..] in the 01-07 shell scripts.
2. Refactor the input/output management of Unit Kinds and how we pass those values to units. My favorite is to have some sort of YAML parsing.

## DOs/DONTs

Rather than having something like this, which is error prone,

```bash
    bin/01-create-saas.sh "${SAAS_NAME}"    bin/02-create-unit-kind.sh "${SAAS_NAME}" "${SAAS_NAME}"
    bin/03-build-and-push-blueprint.sh terraform-modules/terraform-vm
    bin/04-create-release.sh "${RELEASE_NAME}"
    bin/04a-reposition-uk-default.sh "${SAAS_NAME}" "${RELEASE_NAME}"
    bin/05-create-unit.sh "${SAAS_NAME}" "${SAAS_NAME}"
    bin/06-provision-unit.sh "unit-${SAAS_NAME}" "${RELEASE_NAME}"
    echo "âœ… End-to-end deployment complete!"
```

I'd like to have some sort of positional arguments like this:

```bash
 bin/04a-reposition-uk-default.sh --saas-runtime "${SAAS_NAME}" --release "${RELEASE_NAME}"
```

If we're stretching the capabilities of bash too much, it's ok to use a more mature language, as long as we install AS FEW DEPS as we can't. I dont want to use Google Client Libraries, but wrap as much gcloud as we can. This is because I don't want to create a product, I want to do something that people are able reproduce manually, hence the gcloud CLI part.

If a language needs to be chosen (but please please please lets try to keep bash!) I think Ruby is the best choice, as it supports the backticks `command` natively, so should be quite readable. Again, if we decide that Bash is not the way, Ruby needs to be readable also by non-rubyists.

## Current Plan & Status (as of 2025-07-24)

### What's been done:

1.  **`bin/05-create-unit.sh` modification:**
    *   Removed the "unit-" prefix from `SAAS_UNIT_NAME` as it was redundant.
2.  **`bin/04-create-release.sh` modification:**
    *   Modified to append a timestamp to the release name to ensure uniqueness and output only the full resource name.

### What's failing:

The `run-e2e-test.sh` script was failing during the cleanup phase due to an incorrect cleanup order and issues with capturing the dynamically generated release name. The correct cleanup order is documented in `bin/dangerous-destroy-all-saas-entities.sh`.

### New Plan: Refactor Scripts Individually & Implement YAML-driven E2E

We will halt the full e2e test debugging for now and focus on refactoring the individual scripts (`01-07`) one by one, starting with `01-create-saas.sh`. This will allow for a smaller blast radius and easier verification.

#### Refactoring Individual Scripts:

*   [x] **`bin/01-create-saas.sh`:** Refactor to accept `--saas-name` as a command-line argument instead of relying on environment variables. (Verified with `vm-saas-offering` and `classroom-saas-offering`)
*   [ ] **`bin/02-create-unit-kind.sh`:** Refactor to accept arguments via flags.
*   [ ] **`bin/03-build-and-push-blueprint.sh`:** Refactor to accept arguments via flags.
*   [ ] **`bin/04-create-release.sh`:** (Already modified to output only the resource name, but needs flag refactoring).
*   [ ] **`bin/04a-reposition-uk-default.sh`:** Refactor to accept arguments via flags.
*   [ ] **`bin/05-create-unit.sh`:** (Already modified for `SAAS_UNIT_NAME`, but needs flag refactoring).
*   [ ] **`bin/06-provision-unit.sh`:** Refactor to accept arguments via flags.
*   [ ] **`bin/07-create-rollout.sh`:** Refactor to accept arguments via flags.
*   [ ] **`bin/08-deprovision-unit.sh`:** Refactor to accept arguments via flags.

#### YAML Input/Output Management & Two E2E Behaviors:

Once individual scripts are refactored, we will implement two end-to-end behaviors. This will involve:

1.  Creating two sample YAML files in `etc/` that define all the necessary parameters for a complete SaaS offering deployment.
2.  Developing a new orchestrator script (or modifying an existing one) that:
    *   Reads the parameters from these YAML files using `yq` (or `jq` if JSON is preferred).
    *   Calls the refactored individual scripts (`01-08`) with the extracted values to deploy a full SaaS offering.
    *   Includes a cleanup mechanism based on the correct order identified in `bin/dangerous-destroy-all-saas-entities.sh`.

### Next Steps:

1.  Start refactoring `bin/02-create-unit-kind.sh` to accept arguments via flags.
2.  Verify the refactored `02-create-unit-kind.sh` by manually calling it and checking the UI.
