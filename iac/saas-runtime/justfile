TERRAFORM_CLASSROOM_FOLDER_DIR := "terraform-modules/terraform-classroom-folder"

# list targets
list:
    just -l

check-setup:
    #!/bin/bash
    source .env
    bin/check-setup.sh


# create SaaS Runtime instance
create-saas:
    #!/bin/bash
    source .env
    bin/01-create-saas.sh

check:
    #!/bin/bash
    source .env
    bin/check-saas-overall-status.sh

create-classroom-folder-unit-kind:
    #!/bin/bash
    source .env
    bin/03-create-unit-kind.sh classroom-folder {{TERRAFORM_CLASSROOM_FOLDER_DIR}}

create-sample-vm-unit-kind:
    #!/bin/bash
    source .env
    bin/03-create-unit-kind.sh sandmold-sample-vm terraform-modules/terraform-vm

build-and-push-blueprint:
    #!/bin/bash
    source .env
    bin/05-build-and-push-blueprint.sh {{TERRAFORM_CLASSROOM_FOLDER_DIR}}

docker check:
    docker ps

create-rollout:
    #!/bin/bash
    source .env
    bin/07-create-rollout.sh

check-logs:
    #!/bin/bash
    source .env
    bin/check-audit-logs.sh

create-sample-unit name:
    #!/bin/bash
    source .env
    bin/05-create-unit.sh unit-{{name}} ${UNIT_KIND_NAME_GLOBAL}

create-global-unit name:
    #!/bin/bash
    source .env
    bin/05-create-unit.sh {{name}} ${UNIT_KIND_NAME_BASE}-global
    bin/06-provision-unit.sh {{name}}

create-regional-unit name:
    #!/bin/bash
    source .env
    bin/05-create-unit.sh {{name}} ${UNIT_KIND_NAME_BASE}-regional
    bin/06-provision-unit.sh unit-{{name}}

cloudbuild-retrieve-log-global BUILD_ID:
    #!/bin/bash
    source .env
    echo "1. Testing global first.. then regional on ${GOOGLE_CLOUD_REGION}.."
    gcloud builds log {{BUILD_ID}} --project="${GOOGLE_CLOUD_PROJECT}" | tee log/cb-global-{{BUILD_ID}}.log
    echo "✅ Successfully retrieved log for global build: log/cb-global-{{BUILD_ID}}.log"

cloudbuild-retrieve-log-regional BUILD_ID:
    #!/bin/bash
    source .env
    gcloud builds log {{BUILD_ID}} --project="${GOOGLE_CLOUD_PROJECT}" --region=${GOOGLE_CLOUD_REGION} |
        tee log/cb-regional-{{BUILD_ID}}.${GOOGLE_CLOUD_REGION}.log
    echo "✅ Successfully retrieved log for regional build ${GOOGLE_CLOUD_REGION}: log/cb-regional-{{BUILD_ID}}.${GOOGLE_CLOUD_REGION}.log"

cloudbuild-retrieve-all-logs:
    #!/bin/bash
    source .env
    echo "1. Global Builds - max 5:"
    gcloud builds list --project="${GOOGLE_CLOUD_PROJECT}" --limit 5 # --sort-by="createTime"

clean:
    #!/bin/bash
    rm -rf build/

deploy-saas-end2end:
    #!/bin/bash
    set -e
    echo "Running end-to-end SaaS deployment for 'sandmold-test-cli-e2e'"
    export RELEASE_NAME_BASE="e2e-test-$(date +%Y%m%d-%H%M)"
    bin/01-create-saas.sh
    bin/02-create-unit-kind.sh sandmold-sample-vm terraform-modules/terraform-vm
    bin/03-build-and-push-blueprint.sh terraform-modules/terraform-vm
    bin/04-create-release.sh
    bin/04a-reposition-uk-default.sh
    bin/05-create-unit.sh sandmold-test-cli-e2e
    bin/06-provision-unit.sh unit-sandmold-test-cli-e2e
    echo "✅ End-to-end deployment complete!"